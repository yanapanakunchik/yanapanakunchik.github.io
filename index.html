<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="color-scheme" content="light" />
  <meta name="theme-color" content="#F4F4F4" />
  <title>Yanapanakunchik - Comercio Justo en Cusco</title>
  <link rel="stylesheet" href="styles-optimized.css" />
  <style>
    /* Cookie Consent Banner */
    .cookie-consent-banner {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(25, 25, 25, 0.9);
      backdrop-filter: blur(8px);
      color: #fff;
      padding: 1.25rem;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1.25rem;
      z-index: 3000;
      transform: translateY(100%);
      transition: transform 0.5s ease-in-out;
      flex-wrap: wrap;
      text-align: center;
    }
    .cookie-consent-banner.show {
      transform: translateY(0);
    }
    .cookie-consent-banner p {
      margin: 0;
      font-size: 0.95em;
      flex-grow: 1;
    }
    .cookie-consent-banner .buttons {
      display: flex;
      gap: 0.75rem;
      flex-shrink: 0;
    }
    .cookie-consent-banner button {
      width: auto;
      padding: 0.6rem 1.2rem;
      border-radius: 50px;
      font-weight: 600;
      cursor: pointer;
    }
    .cookie-consent-banner .accept-btn {
      background: var(--accent-color);
      color: white;
    }
    .cookie-consent-banner .reject-btn {
      background: #444;
      color: white;
    }
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- 
    PASO 1: Aquí pegarías el código principal que te da Google AdSense.
    Suele ser un script que se carga de forma asíncrona.
    Ejemplo: <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-xxxxxxxxxxxxxxxx" crossorigin="anonymous"></script>
  -->
</head>
<body>
  <header class="site-header">
    <div class="container">
      <div class="logo">
        <h1>Yanapanakunchik</h1>
      </div>
      <nav class="main-nav">
        <a href="#objetivo">Nuestro Objetivo</a>
        <a href="sobre-nosotros.html">Sobre Nosotros</a>
        <a href="tienda.html">Tienda</a>
        <a href="blog.html">Blog</a>
        <a href="contacto.html">Contacto</a>
      </nav>
      <div class="auth-actions" id="auth-actions">
        <button class="login-button" id="open-login-modal">Iniciar sesión</button>
      </div>
      <div id="auth-container" style="display:none">
          <div id="g_id_signin" style="display:none"></div>
          <div id="user-profile" style="display: none;">
              <img id="user-pic" src="" alt="User Picture">
              <span id="user-name"></span>
              <button id="logout-button" onclick="signOut();">Cerrar Sesión</button>
          </div>
      </div>
    </div>
  </header>

  <main>
    <section id="hero">
      <div class="container">
        <div class="hero-content">
          <h2>Ayudando a crecer a los emprendedores de Cusco</h2>
          <p>Promovemos el comercio justo y sostenible para mejorar la calidad de vida en cusco .</p>
          <a href="tienda.html" class="cta-button">Explora nuestros productos</a>
        </div>
      </div>
    </section>

    <section id="objetivo" class="page-section">
      <div class="container">
        <h2>Nuestro Objetivo</h2>
        <div class="objetivo-content">
          <div class="objetivo-text">
            <h3>Misión y Visión</h3>
            <p>Nuestra misión es crear un puente directo entre los mejores emprendedores de Cusco y tú. Buscamos eliminar intermediarios para asegurar un pago justo y un desarrollo sostenible para las comunidades productoras. Creemos en un comercio que respeta la cultura, la tradición y el medio ambiente.</p>
          </div>
          <div class="objetivo-image">
            <img src="https://via.placeholder.com/400x300.png?text=Artesanos+de+Cusco" alt="Artesanos de Cusco" />
          </div>
        </div>
      </div>
    </section>

    <!-- 
      PASO 2: Aquí podrías colocar un bloque de anuncio.
      Sería un espacio de publicidad entre la sección "Nuestro Objetivo" y "Personas Ayudadas".
      El código se vería algo así:
      <ins class="adsbygoogle"
           style="display:block"
           data-ad-client="ca-pub-xxxxxxxxxxxxxxxx"
           data-ad-slot="1234567890"
           data-ad-format="auto"
           data-full-width-responsive="true"></ins>
      <script>
           (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    -->

    <section id="ayudados" class="page-section">
      <div class="container">
        <h2>Personas Ayudadas</h2>
        <div class="personas-ayudadas">
            <div class="persona">
                <img src="https://via.placeholder.com/150x150.png?text=Maria+Quispe" alt="Maria Quispe" />
                <h4>Maria Quispe</h4>
                <p>"Gracias a Yanapanakunchik, he podido vender mis tejidos a un precio justo y mantener a mi familia. Siento que mi trabajo es valorado."</p>
            </div>
            <div class="persona">
                <img src="https://via.placeholder.com/150x150.png?text=Juan+Carlos" alt="Juan Carlos" />
                <h4>Juan Carlos</h4>
                <p>"La plataforma me ha permitido llegar a clientes que antes eran inalcanzables. Mis cerámicas ahora se venden en todo el Perú."</p>
            </div>
            <div class="persona">
                <img src="https://via.placeholder.com/150x150.png?text=Familia+Mamani" alt="Familia Mamani" />
                <h4>Familia Mamani</h4>
                <p>"Como familia, hemos podido organizarnos y mejorar nuestra producción. Yanapanakunchik nos ha dado el apoyo que necesitábamos."</p>
            </div>
        </div>
      </div>
    </section>

    <section id="integrantes" class="page-section">
      <div class="container">
        <h2>Integrantes</h2>
        <div class="integrantes-container">
          <div class="integrante">
            <img src="photos/Naomi Adriana Cusi Sullca.jpg" alt="Naomi Adriana Cusi Sullca" />
            <h4>Naomi Adriana Cusi Sullca</h4>
            <p>Gerente General</p>
          </div>
          <div class="integrante">
            <img src="photos/Yhon Franco Gomez Colquer.jpg" alt="Yhon Franco Gomez Colquer" />
            <h4>Yhon Franco Gomez Colquer</h4>
            <p>Gerente de Recursos Humanos</p>
          </div>
          <div class="integrante">
            <img src="photos/Daniela Sami Cusihuallpa Cusicuna.jpg" alt="Daniela Sami Cusihuallpa Cusicuna" />
            <h4>Daniela Sami Cusihuallpa Cusicuna</h4>
            <p>Gerente de Marketing</p>
          </div>
          <div class="integrante">
            <img src="photos/Abraham Huallpa Sullo.jpg" alt="Abraham Huallpa Sullo" />
            <h4>Abraham Huallpa Sullo</h4>
            <p>Gerente de T.I.</p>
          </div>
          <div class="integrante">
            <img src="photos/Solange Yadira Cueva Chacmani.jpg" alt="Solange Yadira Cueva Chacmani" />
            <h4>Solange Yadira Cueva Chacmani</h4>
            <p>Gerente de Finanzas</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container">
      <h2>Comunícate con Nosotros</h2>
      <p>¿Interesado en nuestros productos o en apoyar nuestra causa? Contáctanos.</p>
      <p>Email: <a href="mailto:info@yanapanakunchik.com">info@yanapanakunchik.com</a> | Teléfono: +51 987 654 321</p>
      <p><a href="contacto.html" class="cta-button" style="display: inline-block; margin-top: 1rem;">Ver Página de Contacto Completa</a></p>
      
      <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #ddd; text-align: center;">
        <p>&copy; 2024 Yanapanakunchik. Todos los derechos reservados.</p>
        <p>Comercio Justo y Sostenible en Cusco, Perú</p>
        <div style="margin-top: 1rem;">
          <a href="politica-privacidad.html" style="color: #666; text-decoration: none; margin: 0 1rem;">Política de Privacidad</a>
        </div>
      </div>
    </div>
  </footer>

  <!-- Script de protección y marca de agua -->
  <script src="protection.js"></script>

  <!-- Login Modal -->
  <div class="modal-overlay" id="login-modal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Iniciar sesión</div>
        <button class="modal-close" id="close-login-modal" aria-label="Cerrar">×</button>
      </div>
      <div class="modal-body">
        <div class="tabs">
          <button class="tab-button active" data-tab="google-tab">Google</button>
          <button class="tab-button" data-tab="email-tab">Correo / Usuario</button>
        </div>
        <div class="tab-panel active" id="google-tab">
          <div id="g_id_signin_modal"></div>
        </div>
        <div class="tab-panel" id="email-tab">
          <form id="login-form">
            <div class="form-group">
              <label for="username">Usuario o correo</label>
              <input type="text" id="username" name="username" required>
            </div>
            <div class="form-group">
              <label for="password">Contraseña</label>
              <input type="password" id="password" name="password" required>
            </div>
            <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
              <label for="remember-me" style="display: flex; align-items: center; margin-bottom: 0; cursor: pointer;">
                <input type="checkbox" id="remember-me" name="remember-me" style="margin-right: 8px;">
                Recordarme
              </label>
            </div>
            <button type="submit">Entrar</button>
          </form>
          <p style="text-align:center;margin-top:10px;">¿No tienes cuenta? <a href="register.html">Regístrate</a></p>
        </div>
      </div>
    </div>
  </div>

  <script>
    function decodeJwtResponse(token) {
        var base64Url = token.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
    }

    function handleCredentialResponse(response) {
      const responsePayload = decodeJwtResponse(response.credential);
      console.log("Logged in as: " + responsePayload.name);
      
      sessionStorage.setItem("userName", responsePayload.name);
      sessionStorage.setItem("userPic", responsePayload.picture);
      sessionStorage.setItem("userCredential", response.credential);

      updateUI(responsePayload.name, responsePayload.picture);
      closeLoginModal();
    }

    function updateUI(name, pic) {
        const authActions = document.getElementById('auth-actions');
        if (authActions) authActions.style.display = 'none';
        const userProfile = document.getElementById('user-profile');
        if (userProfile) {
            userProfile.style.display = "flex";
            document.getElementById('user-pic').src = pic;
            document.getElementById('user-name').innerText = name;
        }
    }

    function signOut() {
        google.accounts.id.disableAutoSelect();
        sessionStorage.clear();
        localStorage.removeItem('user'); // Borrar usuario recordado
        const authActions = document.getElementById('auth-actions');
        if (authActions) authActions.style.display = 'flex';
        const userProfile = document.getElementById('user-profile');
        if (userProfile) {
            userProfile.style.display = "none";
        }
        console.log('User signed out.');
    }

    // Modal logic
    const modalEl = document.getElementById('login-modal');
    const openBtn = document.getElementById('open-login-modal');
    const closeBtn = document.getElementById('close-login-modal');

    function openLoginModal() {
      modalEl.classList.add('open');
    }
    function closeLoginModal() {
      modalEl.classList.remove('open');
    }

    if (openBtn) openBtn.addEventListener('click', openLoginModal);
    if (closeBtn) closeBtn.addEventListener('click', closeLoginModal);
    modalEl.addEventListener('click', (e) => { if (e.target === modalEl) closeLoginModal(); });

    // Tabs
    document.querySelectorAll('.tab-button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        btn.classList.add('active');
        const panel = document.getElementById(btn.dataset.tab);
        if (panel) panel.classList.add('active');
      });
    });

    // Enhanced login validation
    function validateLoginForm(formData) {
        const errors = [];
        
        if (!formData.username || formData.username.trim() === '') {
            errors.push('El usuario o correo es requerido');
        }
        
        if (!formData.password || formData.password.trim() === '') {
            errors.push('La contraseña es requerida');
        }
        
        if (formData.username && formData.username.includes('@')) {
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(formData.username)) {
                errors.push('El formato del correo electrónico no es válido');
            }
        }
        
        return errors;
    }

    function showLoginError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'login-error';
        errorDiv.textContent = message;
        errorDiv.style.cssText = `
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #ffcdd2;
            font-size: 14px;
        `;
        
        const form = document.getElementById('login-form');
        const existingError = form.querySelector('.login-error');
        if (existingError) {
            existingError.remove();
        }
        form.insertBefore(errorDiv, form.firstChild);
        
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.remove();
            }
        }, 5000);
    }

    function showLoginSuccess(message) {
        const successDiv = document.createElement('div');
        successDiv.className = 'login-success';
        successDiv.textContent = message;
        successDiv.style.cssText = `
            background: #e8f5e8;
            color: #2e7d32;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #c8e6c9;
            font-size: 14px;
        `;
        
        const form = document.getElementById('login-form');
        const existingSuccess = form.querySelector('.login-success');
        if (existingSuccess) {
            existingSuccess.remove();
        }
        form.insertBefore(successDiv, form.firstChild);
        
        setTimeout(() => {
            if (successDiv.parentNode) {
                successDiv.remove();
            }
        }, 3000);
    }

    // Enhanced form submission for login
    document.addEventListener('DOMContentLoaded', function() {
        const loginForm = document.getElementById('login-form');
        if (loginForm) {
            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = {
                    username: this.username.value.trim(),
                    password: this.password.value
                };
                
                // Validate form
                const errors = validateLoginForm(formData);
                if (errors.length > 0) {
                    showLoginError(errors.join(', '));
                    return;
                }
                
                try {
                    const response = await fetch(`http://localhost:3000/users?username=${encodeURIComponent(formData.username)}&password=${encodeURIComponent(formData.password)}`);
                    const users = await response.json();
                    
                    if (users.length > 0) {
                        // Login successful
                        const rememberMe = document.getElementById('remember-me').checked;
                        if (rememberMe) {
                            localStorage.setItem('user', JSON.stringify(users[0]));
                        } else {
                            sessionStorage.setItem('user', JSON.stringify(users[0]));
                        }

                        showLoginSuccess('Inicio de sesión exitoso');
                        closeLoginModal();
                        
                        // Reload to update UI
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        showLoginError('Usuario o contraseña incorrectos');
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    showLoginError('Error de conexión. Verifica que el servidor esté ejecutándose.');
                }
            });
        }
    });

    window.onload = function () {
      google.accounts.id.initialize({
        client_id: "79813298776-jctbcrchdefnv2vdbpqvj2fghf0gjqgf.apps.googleusercontent.com",
        callback: handleCredentialResponse
      });
      
      // Check for persisted sessions (Google or local)
      const userCredential = sessionStorage.getItem("userCredential");
      const localUserJson = localStorage.getItem('user') || sessionStorage.getItem('user');

      if (userCredential) {
        const payload = decodeJwtResponse(userCredential);
        updateUI(payload.name, payload.picture);
      } else if (localUserJson) {
        const userData = JSON.parse(localUserJson);
        // Usamos el nombre de usuario y una imagen genérica
        updateUI(userData.username, `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.username)}&background=008080&color=fff`);
      } else {
        // Render Google button in modal if no one is logged in
        const target = document.getElementById("g_id_signin_modal");
        if (target) {
          google.accounts.id.renderButton(target, { theme: "outline", size: "large", text: "signin_with", shape: "rectangular", logo_alignment: "left" });
        }
      }

      // Cookie Consent Logic
      const consentBanner = document.getElementById('cookie-consent-banner');
      if (consentBanner) {
        const acceptBtn = document.getElementById('accept-cookies');
        const rejectBtn = document.getElementById('reject-cookies');
        const cookieConsent = localStorage.getItem('cookieConsent');

        if (!cookieConsent) {
          setTimeout(() => {
            consentBanner.classList.add('show');
          }, 1500);
        }

        acceptBtn.addEventListener('click', () => {
          localStorage.setItem('cookieConsent', 'accepted');
          consentBanner.classList.remove('show');
        });

        rejectBtn.addEventListener('click', () => {
          localStorage.setItem('cookieConsent', 'rejected');
          consentBanner.classList.remove('show');
        });
      }
    };
  </script>
  <script src="auth.js"></script>
  <!-- Cookie Consent Banner -->
  <div class="cookie-consent-banner" id="cookie-consent-banner">
    <p>Utilizamos cookies para la funcionalidad de "Recordarme". Al aceptar, consientes su uso.</p>
    <div class="buttons">
      <button class="accept-btn" id="accept-cookies">Aceptar</button>
      <button class="reject-btn" id="reject-cookies">Rechazar</button>
    </div>
  </div>
</body>
</html>
