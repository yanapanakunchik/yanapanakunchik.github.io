<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="color-scheme" content="light" />
  <meta name="theme-color" content="#F4F4F4" />
  <title>Tienda - Yanapanakunchik</title>
  <link rel="stylesheet" href="styles-optimized.css" />
  <link rel="stylesheet" href="tienda.css" />
  <style>
    /* Cookie Consent Banner */
    .cookie-consent-banner {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(25, 25, 25, 0.9);
      backdrop-filter: blur(8px);
      color: #fff;
      padding: 1.25rem;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1.25rem;
      z-index: 3000;
      transform: translateY(100%);
      transition: transform 0.5s ease-in-out;
      flex-wrap: wrap;
      text-align: center;
    }
    .cookie-consent-banner.show {
      transform: translateY(0);
    }
    .cookie-consent-banner p {
      margin: 0;
      font-size: 0.95em;
      flex-grow: 1;
    }
    .cookie-consent-banner .buttons {
      display: flex;
      gap: 0.75rem;
      flex-shrink: 0;
    }
    .cookie-consent-banner button {
      width: auto;
      padding: 0.6rem 1.2rem;
      border-radius: 50px;
      font-weight: 600;
      cursor: pointer;
    }
    .cookie-consent-banner .accept-btn {
      background: var(--accent-color);
      color: white;
    }
    .cookie-consent-banner .reject-btn {
      background: #444;
      color: white;
    }
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <header>
    <div class="container">
      <div class="logo">
        <h1><a href="index.html">Yanapanakunchik</a></h1>
      </div>
      <nav>
        <a href="index.html#objetivo">Nuestro Objetivo</a>
        <a href="sobre-nosotros.html">Sobre Nosotros</a>
        <a href="tienda.html">Tienda</a>
        <a href="blog.html">Blog</a>
        <a href="contacto.html">Comun√≠cate con Nosotros</a>
      </nav>
      <div class="cart-icon">
        <a href="#" id="cart-link" class="cart-button">
          <span class="cart-icon-text">üõí</span>
          <span class="cart-count" id="cart-count">0</span>
        </a>
      </div>
      <div class="auth-actions" id="auth-actions">
        <button class="login-button" id="open-login-modal">Iniciar sesi√≥n</button>
      </div>
      <div id="auth-container">
          <div id="g_id_signin" style="display:none"></div>
          <div id="user-profile" style="display: none;">
              <img id="user-pic" src="" alt="User Picture">
              <span id="user-name"></span>
              <button id="user-menu-toggle" class="user-menu-toggle">‚ñº</button>
              <div id="user-menu" class="user-menu">
                <a href="#" id="profile-tab-link" class="user-menu-item">Mi Perfil</a>
                <a href="#" id="send-product-link" class="user-menu-item">Enviar Producto</a>
                <button id="logout-button" class="user-menu-item logout-btn" onclick="signOut();">Cerrar Sesi√≥n</button>
              </div>
          </div>
      </div>
    </div>
  </header>

  <main>
    <!-- Tabs Navigation -->
    <div class="tabs-navigation" id="tabs-navigation" style="display: none;">
      <div class="container">
        <button class="tab-nav-btn active" data-tab="tienda-tab">Tienda</button>
        <button class="tab-nav-btn" data-tab="profile-tab">Mi Perfil</button>
        <button class="tab-nav-btn" data-tab="send-product-tab">Enviar Producto</button>
      </div>
    </div>

    <!-- Tienda Tab -->
    <div class="tab-content active" id="tienda-tab">
      <section class="page-title">
        <div class="container">
          <h1>Nuestra Tienda</h1>
          <p>Descubre productos √∫nicos y aut√©nticos de los artesanos de Cusco</p>
        </div>
      </section>

      <section id="tienda-productos">
        <div class="container">
          <div class="productos-grid" id="productos-grid">
            <!-- Los productos se cargar√°n aqu√≠ din√°micamente -->
          </div>
        </div>
      </section>

      <section id="carrito-compras" style="display: none;">
        <div class="container">
          <h2>Carrito de Compras</h2>
          <div id="cart-items" class="cart-items">
            <!-- Los productos del carrito se mostrar√°n aqu√≠ -->
          </div>
          <div class="cart-summary">
            <p class="cart-total">Total: S/ <span id="cart-total">0.00</span></p>
            <button id="checkout-btn" class="checkout-button">Proceder al Pago</button>
          </div>
        </div>
      </section>
    </div>

    <!-- Profile Tab -->
    <div class="tab-content" id="profile-tab">
      <section class="page-title">
        <div class="container">
          <h1>Mi Perfil</h1>
          <p>Gestiona tu informaci√≥n personal y preferencias</p>
        </div>
      </section>

      <section class="profile-section">
        <div class="container">
          <div class="profile-card">
            <div class="profile-header">
              <img id="profile-pic" src="" alt="Foto de perfil" class="profile-picture">
              <div class="profile-info">
                <h2 id="profile-name">Nombre del Usuario</h2>
                <p id="profile-email">usuario@email.com</p>
                <span class="member-since">Miembro desde: <span id="member-date">2024</span></span>
              </div>
            </div>
            
            <div class="profile-stats">
              <div class="stat-item">
                <span class="stat-number" id="orders-count">0</span>
                <span class="stat-label">Pedidos Realizados</span>
              </div>
              <div class="stat-item">
                <span class="stat-number" id="favorites-count">0</span>
                <span class="stat-label">Productos Favoritos</span>
              </div>
              <div class="stat-item">
                <span class="stat-number" id="reviews-count">0</span>
                <span class="stat-label">Rese√±as Escritas</span>
              </div>
            </div>

            <div class="profile-actions">
              <button class="profile-btn primary">Editar Perfil</button>
              <button class="profile-btn secondary">Cambiar Contrase√±a</button>
              <button class="profile-btn secondary">Preferencias</button>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- Send Product Tab -->
    <div class="tab-content" id="send-product-tab">
      <section class="page-title">
        <div class="container">
          <h1>Enviar Producto</h1>
          <p>¬øTienes un producto artesanal que quieres vender? ¬°Env√≠anoslo!</p>
        </div>
      </section>

      <section class="send-product-section">
        <div class="container">
          <div class="send-product-card">
            <div class="form-header">
              <h2>Formulario de Producto</h2>
              <p>Completa la informaci√≥n de tu producto artesanal para que podamos evaluarlo</p>
            </div>

            <form id="send-product-form" class="send-product-form">
              <div class="form-row">
                <div class="form-group">
                  <label for="product-name">Nombre del Producto *</label>
                  <input type="text" id="product-name" name="product-name" required>
                </div>
                <div class="form-group">
                  <label for="product-category">Categor√≠a *</label>
                  <select id="product-category" name="product-category" required>
                    <option value="">Selecciona una categor√≠a</option>
                    <option value="textiles">Textiles</option>
                    <option value="ceramica">Cer√°mica</option>
                    <option value="joyeria">Joyer√≠a</option>
                    <option value="madera">Trabajos en Madera</option>
                    <option value="cuero">Trabajos en Cuero</option>
                    <option value="metal">Trabajos en Metal</option>
                    <option value="otros">Otros</option>
                  </select>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="product-price">Precio Sugerido (S/) *</label>
                  <input type="number" id="product-price" name="product-price" min="0" step="0.01" required>
                </div>
                <div class="form-group">
                  <label for="product-quantity">Cantidad Disponible *</label>
                  <input type="number" id="product-quantity" name="product-quantity" min="1" required>
                </div>
              </div>

              <div class="form-group">
                <label for="product-description">Descripci√≥n del Producto *</label>
                <textarea id="product-description" name="product-description" rows="4" required 
                          placeholder="Describe tu producto, materiales utilizados, t√©cnicas empleadas, historia cultural, etc."></textarea>
              </div>

              <div class="form-group">
                <label for="product-images">Im√°genes del Producto</label>
                <div class="file-upload-area">
                  <input type="file" id="product-images" name="product-images" multiple accept="image/*">
                  <div class="file-upload-text">
                    <span class="upload-icon">üì∑</span>
                    <p>Arrastra las im√°genes aqu√≠ o haz clic para seleccionar</p>
                    <small>M√°ximo 5 im√°genes, formato JPG, PNG o WebP</small>
                  </div>
                </div>
                <div id="image-preview" class="image-preview"></div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="artisan-name">Nombre del Artesano *</label>
                  <input type="text" id="artisan-name" name="artisan-name" required>
                </div>
                <div class="form-group">
                  <label for="artisan-phone">Tel√©fono de Contacto</label>
                  <input type="tel" id="artisan-phone" name="artisan-phone">
                </div>
              </div>

              <div class="form-group">
                <label for="artisan-story">Historia del Artesano</label>
                <textarea id="artisan-story" name="artisan-story" rows="3" 
                          placeholder="Cu√©ntanos sobre el artesano, su experiencia, tradici√≥n familiar, etc."></textarea>
              </div>

              <div class="form-group">
                <label for="additional-info">Informaci√≥n Adicional</label>
                <textarea id="additional-info" name="additional-info" rows="3" 
                          placeholder="Cualquier informaci√≥n adicional que consideres relevante"></textarea>
              </div>

              <div class="form-actions">
                <button type="submit" class="submit-btn">Enviar Producto</button>
                <button type="reset" class="reset-btn">Limpiar Formulario</button>
              </div>
            </form>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer id="contacto" class="site-footer">
    <div class="container">
      <h2>Comun√≠cate con Nosotros</h2>
      <p>¬øInteresado en nuestros productos o en apoyar nuestra causa? Cont√°ctanos.</p>
      <p>Email: <a href="mailto:info@yanapanakunchik.com">info@yanapanakunchik.com</a></p>
      <p>Tel√©fono: +51 987 654 321</p>
    </div>
  </footer>

  <!-- Login Modal -->
  <div class="modal-overlay" id="login-modal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Iniciar sesi√≥n</div>
        <button class="modal-close" id="close-login-modal" aria-label="Cerrar">√ó</button>
      </div>
      <div class="modal-body">
        <div class="tabs">
          <button class="tab-button active" data-tab="google-tab">Google</button>
          <button class="tab-button" data-tab="email-tab">Correo / Usuario</button>
        </div>
        <div class="tab-panel active" id="google-tab">
          <div id="g_id_signin_modal"></div>
        </div>
        <div class="tab-panel" id="email-tab">
          <form id="login-form">
            <div class="form-group">
              <label for="username">Usuario o correo</label>
              <input type="text" id="username" name="username" required>
            </div>
            <div class="form-group">
              <label for="password">Contrase√±a</label>
              <input type="password" id="password" name="password" required>
            </div>
            <div class="form-group" style="display: flex; align-items: center; justify-content: space-between;">
              <label for="remember-me-tienda" style="display: flex; align-items: center; margin-bottom: 0; cursor: pointer;">
                <input type="checkbox" id="remember-me-tienda" name="remember-me-tienda" style="margin-right: 8px;">
                Recordarme
              </label>
            </div>
            <button type="submit">Entrar</button>
          </form>
          <p style="text-align:center;margin-top:10px;">¬øNo tienes cuenta? <a href="register.html">Reg√≠strate</a></p>
        </div>
      </div>
    </div>
  </div>

  <script>
    function decodeJwtResponse(token) {
        var base64Url = token.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
    }

    function handleCredentialResponse(response) {
      const responsePayload = decodeJwtResponse(response.credential);
      console.log("Logged in as: " + responsePayload.name);
      
      sessionStorage.setItem("userName", responsePayload.name);
      sessionStorage.setItem("userPic", responsePayload.picture);
      sessionStorage.setItem("userCredential", response.credential);
      sessionStorage.setItem("userEmail", responsePayload.email);

      updateUI(responsePayload.name, responsePayload.picture, responsePayload.email);
      closeLoginModal();
    }

    function updateUI(name, pic, email) {
        document.getElementById('g_id_signin').style.display = "none";
        const authActions = document.getElementById('auth-actions');
        if (authActions) authActions.style.display = 'none';
        const userProfile = document.getElementById('user-profile');
        if (userProfile) {
            userProfile.style.display = "flex";
            document.getElementById('user-pic').src = pic;
            document.getElementById('user-name').innerText = name;
        }
        
        // Show tabs navigation for logged in users
        const tabsNavigation = document.getElementById('tabs-navigation');
        if (tabsNavigation) tabsNavigation.style.display = 'block';
        
        // Update profile tab with user info
        if (email) {
            document.getElementById('profile-pic').src = pic;
            document.getElementById('profile-name').innerText = name;
            document.getElementById('profile-email').innerText = email;
        }
    }

    function signOut() {
        google.accounts.id.disableAutoSelect();
        sessionStorage.clear();
        localStorage.removeItem('user'); // Borrar usuario recordado
        const authActions = document.getElementById('auth-actions');
        if (authActions) authActions.style.display = 'flex';
        document.getElementById('g_id_signin').style.display = "block";
        const userProfile = document.getElementById('user-profile');
        if (userProfile) {
            userProfile.style.display = "none";
        }
        
        // Hide tabs navigation for logged out users
        const tabsNavigation = document.getElementById('tabs-navigation');
        if (tabsNavigation) tabsNavigation.style.display = 'none';
        
        // Reset to tienda tab
        showTab('tienda-tab');
        
        console.log('User signed out.');
    }

    function loadProducts() {
      fetch('db.json')
        .then(response => response.json())
        .then(data => {
          const productsGrid = document.getElementById('productos-grid');
          productsGrid.innerHTML = '';
          data.products.forEach((product, index) => {
            const productElement = document.createElement('div');
            productElement.className = 'producto';
            productElement.style.animationDelay = `${index * 0.1}s`;
            productElement.innerHTML = `
              <img src="${product.image}" alt="${product.name}" loading="lazy" />
              <h3>${product.name}</h3>
              <p>S/ ${product.price.toFixed(2)}</p>
              <button class="add-to-cart-btn" data-id="${product.id}">
                <span class="btn-text">A√±adir al carrito</span>
                <span class="btn-icon">+</span>
              </button>
            `;
            productsGrid.appendChild(productElement);
          });
        })
        .catch(error => {
          console.error('Error loading products:', error);
          document.getElementById('productos-grid').innerHTML = 
            '<p class="error-message">Error al cargar los productos. Por favor, intenta de nuevo.</p>';
        });
    }

    // Tab navigation functions
    function showTab(tabId) {
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Remove active class from all tab buttons
      document.querySelectorAll('.tab-nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected tab content
      const selectedTab = document.getElementById(tabId);
      if (selectedTab) {
        selectedTab.classList.add('active');
      }
      
      // Add active class to selected tab button
      const selectedBtn = document.querySelector(`[data-tab="${tabId}"]`);
      if (selectedBtn) {
        selectedBtn.classList.add('active');
      }
    }

    // Modal logic
    const modalEl = document.getElementById('login-modal');
    const openBtn = document.getElementById('open-login-modal');
    const closeBtn = document.getElementById('close-login-modal');

    function openLoginModal() { modalEl.classList.add('open'); }
    function closeLoginModal() { modalEl.classList.remove('open'); }

    if (openBtn) openBtn.addEventListener('click', openLoginModal);
    if (closeBtn) closeBtn.addEventListener('click', closeLoginModal);
    modalEl.addEventListener('click', (e) => { if (e.target === modalEl) closeLoginModal(); });

    // Tabs
    document.querySelectorAll('.tab-button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        btn.classList.add('active');
        const panel = document.getElementById(btn.dataset.tab);
        if (panel) panel.classList.add('active');
      });
    });

    window.onload = function () {
      google.accounts.id.initialize({
        client_id: "79813298776-jctbcrchdefnv2vdbpqvj2fghf0gjqgf.apps.googleusercontent.com",
        callback: handleCredentialResponse
      });
      
      // Check for persisted sessions (Google or local)
      const userCredential = sessionStorage.getItem("userCredential");
      const localUserJson = localStorage.getItem('user') || sessionStorage.getItem('user');

      if (userCredential) {
        const payload = decodeJwtResponse(userCredential);
        updateUI(payload.name, payload.picture, payload.email);
      } else if (localUserJson) {
        const userData = JSON.parse(localUserJson);
        updateUI(userData.username, `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.username)}&background=008080&color=fff`, userData.email || '');
      } else {
        google.accounts.id.renderButton(
          document.getElementById("g_id_signin_modal"),
          { theme: "outline", size: "large", text: "signin_with", shape: "rectangular", logo_alignment: "left" }
        );
      }

      loadProducts();

      const cartLink = document.getElementById('cart-link');
      const cartSection = document.getElementById('carrito-compras');

      cartLink.addEventListener('click', (e) => {
        e.preventDefault();
        const isCartVisible = cartSection.style.display === 'block';
        cartSection.style.display = isCartVisible ? 'none' : 'block';
        
        if (!isCartVisible) {
            cartSection.classList.add('slide-in');
        } else {
            cartSection.classList.remove('slide-in');
        }
      });

      document.getElementById('productos-grid').addEventListener('click', (e) => {
        if (e.target.closest('.add-to-cart-btn')) {
          const button = e.target.closest('.add-to-cart-btn');
          const productId = button.dataset.id;
          addToCart(productId);
          showCartNotification();
        }
      });

      // Checkout button
      document.getElementById('checkout-btn').addEventListener('click', function() {
        if (cart.length === 0) {
          alert('Tu carrito est√° vac√≠o');
          return;
        }
        alert('¬°Gracias por tu compra! Te contactaremos pronto para coordinar el env√≠o.');
        cart = [];
        updateCartUI();
        document.getElementById('carrito-compras').style.display = 'none';
      });

      // Tab navigation event listeners
      document.querySelectorAll('.tab-nav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          showTab(btn.dataset.tab);
        });
      });

      // User menu toggle
      const userMenuToggle = document.getElementById('user-menu-toggle');
      const userMenu = document.getElementById('user-menu');
      
      if (userMenuToggle && userMenu) {
        userMenuToggle.addEventListener('click', (e) => {
          e.stopPropagation();
          userMenu.classList.toggle('show');
        });
        
        // Close menu when clicking outside
        document.addEventListener('click', () => {
          userMenu.classList.remove('show');
        });
      }

      // User menu item clicks
      document.getElementById('profile-tab-link')?.addEventListener('click', (e) => {
        e.preventDefault();
        showTab('profile-tab');
        userMenu.classList.remove('show');
      });

      document.getElementById('send-product-link')?.addEventListener('click', (e) => {
        e.preventDefault();
        showTab('send-product-tab');
        userMenu.classList.remove('show');
      });

      // Send product form handling
      const sendProductForm = document.getElementById('send-product-form');
      if (sendProductForm) {
        sendProductForm.addEventListener('submit', handleSendProduct);
      }

      // File upload preview
      const fileInput = document.getElementById('product-images');
      const imagePreview = document.getElementById('image-preview');
      
      if (fileInput && imagePreview) {
        fileInput.addEventListener('change', handleImagePreview);
      }

      loadCartFromStorage();
    };

    let cart = [];
    let allProducts = [];

    fetch('db.json')
      .then(response => response.json())
      .then(data => {
        allProducts = data.products;
      })
      .catch(error => {
        console.error('Error loading products data:', error);
      });

    function addToCart(productId) {
      const product = allProducts.find(p => p.id == productId);
      if (product) {
        const cartItem = cart.find(item => item.id == productId);
        if (cartItem) {
          cartItem.quantity++;
        } else {
          cart.push({ ...product, quantity: 1 });
        }
        updateCartUI();
        saveCartToStorage();
        showCartNotification();
      }
    }

    function updateCartUI() {
      const cartItemsContainer = document.getElementById('cart-items');
      const cartCount = document.getElementById('cart-count');
      const cartTotal = document.getElementById('cart-total');

      cartItemsContainer.innerHTML = '';
      let total = 0;
      let count = 0;

      cart.forEach(item => {
        const itemElement = document.createElement('div');
        itemElement.className = 'cart-item';
        itemElement.innerHTML = `
          <div class="cart-item-info">
            <span class="cart-item-name">${item.name}</span>
            <span class="cart-item-quantity">Cantidad: ${item.quantity}</span>
          </div>
          <div class="cart-item-price">
            <span>S/ ${(item.price * item.quantity).toFixed(2)}</span>
            <button class="remove-item" data-id="${item.id}">√ó</button>
          </div>
        `;
        cartItemsContainer.appendChild(itemElement);
        total += item.price * item.quantity;
        count += item.quantity;
      });

      cartCount.innerText = count;
      cartTotal.innerText = total.toFixed(2);

      // Add remove functionality
      document.querySelectorAll('.remove-item').forEach(button => {
        button.addEventListener('click', function() {
          const productId = this.dataset.id;
          removeFromCart(productId);
        });
      });
    }

    function removeFromCart(productId) {
      cart = cart.filter(item => item.id != productId);
      updateCartUI();
      saveCartToStorage();
    }

    function saveCartToStorage() {
      localStorage.setItem('yanapanakunchik-cart', JSON.stringify(cart));
    }

    function loadCartFromStorage() {
      const savedCart = localStorage.getItem('yanapanakunchik-cart');
      if (savedCart) {
        cart = JSON.parse(savedCart);
        updateCartUI();
      }
    }

    // Enhanced login validation
    function validateLoginForm(formData) {
      const errors = [];
      
      if (!formData.username || formData.username.trim() === '') {
        errors.push('El usuario o correo es requerido');
      }
      
      if (!formData.password || formData.password.trim() === '') {
        errors.push('La contrase√±a es requerida');
      }
      
      if (formData.username && formData.username.includes('@')) {
        // Email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(formData.username)) {
          errors.push('El formato del correo electr√≥nico no es v√°lido');
        }
      }
      
      return errors;
    }

    function showLoginError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'login-error';
      errorDiv.textContent = message;
      errorDiv.style.cssText = `
        background: #ffebee;
        color: #c62828;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
        border: 1px solid #ffcdd2;
        font-size: 14px;
      `;
      
      const form = document.getElementById('login-form');
      const existingError = form.querySelector('.login-error');
      if (existingError) {
        existingError.remove();
      }
      form.insertBefore(errorDiv, form.firstChild);
      
      setTimeout(() => {
        if (errorDiv.parentNode) {
          errorDiv.remove();
        }
      }, 5000);
    }

    function showLoginSuccess(message) {
      const successDiv = document.createElement('div');
      successDiv.className = 'login-success';
      successDiv.textContent = message;
      successDiv.style.cssText = `
        background: #e8f5e8;
        color: #2e7d32;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
        border: 1px solid #c8e6c9;
        font-size: 14px;
      `;
      
      const form = document.getElementById('login-form');
      const existingSuccess = form.querySelector('.login-success');
      if (existingSuccess) {
        existingSuccess.remove();
      }
      form.insertBefore(successDiv, form.firstChild);
      
      setTimeout(() => {
        if (successDiv.parentNode) {
          successDiv.remove();
        }
      }, 3000);
    }

    // Cart notification helper
    function showCartNotification() {
      const notification = document.createElement('div');
      notification.className = 'cart-notification';
      notification.textContent = 'Producto a√±adido al carrito';
      document.body.appendChild(notification);
      setTimeout(() => notification.classList.add('show'), 50);
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 2000);
    }

    // Send product form handling
    function handleSendProduct(e) {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const productData = {
        name: formData.get('product-name'),
        category: formData.get('product-category'),
        price: parseFloat(formData.get('product-price')),
        quantity: parseInt(formData.get('product-quantity')),
        description: formData.get('product-description'),
        artisanName: formData.get('artisan-name'),
        artisanPhone: formData.get('artisan-phone'),
        artisanStory: formData.get('artisan-story'),
        additionalInfo: formData.get('additional-info'),
        submittedBy: sessionStorage.getItem('userName') || 'Usuario',
        submittedEmail: sessionStorage.getItem('userEmail') || 'usuario@email.com',
        submittedDate: new Date().toISOString()
      };

      // Send email with product information
      sendProductEmail(productData);
      
      // Show success message
      showSendProductSuccess();
      
      // Reset form
      e.target.reset();
      document.getElementById('image-preview').innerHTML = '';
    }

    function sendProductEmail(productData) {
      const emailBody = `
Nuevo producto enviado a Yanapanakunchik

INFORMACI√ìN DEL PRODUCTO:
- Nombre: ${productData.name}
- Categor√≠a: ${productData.category}
- Precio sugerido: S/ ${productData.price}
- Cantidad disponible: ${productData.quantity}
- Descripci√≥n: ${productData.description}

INFORMACI√ìN DEL ARTESANO:
- Nombre: ${productData.artisanName}
- Tel√©fono: ${productData.artisanPhone || 'No proporcionado'}
- Historia: ${productData.artisanStory || 'No proporcionada'}

INFORMACI√ìN ADICIONAL:
${productData.additionalInfo || 'No proporcionada'}

ENVIADO POR:
- Usuario: ${productData.submittedBy}
- Email: ${productData.submittedEmail}
- Fecha: ${new Date(productData.submittedDate).toLocaleString('es-ES')}
      `;

      // Create mailto link
      const mailtoLink = `mailto:info@yanapanakunchik.com?subject=Nuevo Producto: ${encodeURIComponent(productData.name)}&body=${encodeURIComponent(emailBody)}`;
      
      // Open email client
      window.open(mailtoLink);
    }

    function showSendProductSuccess() {
      const successDiv = document.createElement('div');
      successDiv.className = 'send-product-success';
      successDiv.innerHTML = `
        <div class="success-content">
          <span class="success-icon">‚úÖ</span>
          <h3>¬°Producto enviado exitosamente!</h3>
          <p>Hemos abierto tu cliente de correo electr√≥nico. Por favor, env√≠a el correo para completar el proceso.</p>
          <p>Te contactaremos pronto para evaluar tu producto.</p>
        </div>
      `;
      
      document.body.appendChild(successDiv);
      setTimeout(() => successDiv.classList.add('show'), 50);
      
      setTimeout(() => {
        successDiv.classList.remove('show');
        setTimeout(() => successDiv.remove(), 300);
      }, 5000);
    }

    function handleImagePreview(e) {
      const files = e.target.files;
      const preview = document.getElementById('image-preview');
      preview.innerHTML = '';
      
      if (files.length > 5) {
        alert('M√°ximo 5 im√°genes permitidas');
        e.target.value = '';
        return;
      }
      
      Array.from(files).forEach((file, index) => {
        if (index >= 5) return;
        
        if (!file.type.startsWith('image/')) {
          alert('Solo se permiten archivos de imagen');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.className = 'preview-image';
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    }

    // Enhanced form submission
    document.addEventListener('DOMContentLoaded', function() {
      const loginForm = document.getElementById('login-form');
      if (loginForm) {
        loginForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const formData = {
            username: this.username.value.trim(),
            password: this.password.value
          };
          
          // Validate form
          const errors = validateLoginForm(formData);
          if (errors.length > 0) {
            showLoginError(errors.join(', '));
            return;
          }
          
          try {
            const response = await fetch(`http://localhost:3000/users?username=${encodeURIComponent(formData.username)}&password=${encodeURIComponent(formData.password)}`);
            const users = await response.json();
            
            if (users.length > 0) {
              // Login successful
              const rememberMe = document.getElementById('remember-me-tienda').checked;
              if (rememberMe) {
                  localStorage.setItem('user', JSON.stringify(users[0]));
              } else {
                  sessionStorage.setItem('user', JSON.stringify(users[0]));
              }
              
              showLoginSuccess('Inicio de sesi√≥n exitoso');
              closeLoginModal();
              
              // Reload to update UI
              setTimeout(() => {
                window.location.reload();
              }, 1000);
            } else {
              showLoginError('Usuario o contrase√±a incorrectos');
            }
          } catch (error) {
            console.error('Login error:', error);
            showLoginError('Error de conexi√≥n. Verifica que el servidor est√© ejecut√°ndose.');
          }
        });
      }

      // Cookie Consent Logic
      const consentBanner = document.getElementById('cookie-consent-banner');
      if (consentBanner) {
        const acceptBtn = document.getElementById('accept-cookies');
        const rejectBtn = document.getElementById('reject-cookies');
        const cookieConsent = localStorage.getItem('cookieConsent');

        if (!cookieConsent) {
          setTimeout(() => {
            consentBanner.classList.add('show');
          }, 1500);
        }

        acceptBtn.addEventListener('click', () => {
          localStorage.setItem('cookieConsent', 'accepted');
          consentBanner.classList.remove('show');
        });

        rejectBtn.addEventListener('click', () => {
          localStorage.setItem('cookieConsent', 'rejected');
          consentBanner.classList.remove('show');
        });
      }
    });
  </script>
  <script src="auth.js"></script>
  <script src="protection.js"></script>
  <!-- Cookie Consent Banner -->
  <div class="cookie-consent-banner" id="cookie-consent-banner">
    <p>Utilizamos cookies para la funcionalidad de "Recordarme". Al aceptar, consientes su uso.</p>
    <div class="buttons">
      <button class="accept-btn" id="accept-cookies">Aceptar</button>
      <button class="reject-btn" id="reject-cookies">Rechazar</button>
    </div>
  </div>
</body>
</html>
